{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///home/vivek/PRANA/components/ambulance/LiveMapView.tsx"],"sourcesContent":["'use client';\n\nimport React, { useEffect, useState, useRef } from 'react';\nimport L from 'leaflet';\nimport 'leaflet/dist/leaflet.css';\nimport { Coordinates } from '@/lib/types';\n\ninterface LiveMapViewProps {\n  ambulanceLocation: Coordinates | null;\n  hospitalLocation: Coordinates | null;\n  isLoading?: boolean;\n  isTrafficCleared?: boolean;\n  className?: string;\n}\n\nexport function LiveMapView({\n  ambulanceLocation,\n  hospitalLocation,\n  isLoading = false,\n  isTrafficCleared = false,\n  className = \"w-full h-96 rounded-lg overflow-hidden border-2 border-gray-200\",\n}: LiveMapViewProps) {\n  const [map, setMap] = useState<L.Map | null>(null);\n  const [ambulanceMarker, setAmbulanceMarker] = useState<L.Marker | null>(null);\n  const [hospitalMarker, setHospitalMarker] = useState<L.Marker | null>(null);\n  const [activeRoutePoints, setActiveRoutePoints] = useState<[number, number][]>([]);\n  const routeRef = useRef<L.Polyline | null>(null);\n\n  useEffect(() => {\n    if (typeof window === 'undefined') return;\n\n    const mapContainer = document.getElementById('ambulance-map');\n    if (!mapContainer) return;\n\n    // Initialize map (Center on Bangalore)\n    const newMap = L.map('ambulance-map').setView([12.9716, 77.5946], 13);\n\n    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n      attribution: 'Â© OpenStreetMap contributors',\n      maxZoom: 19,\n    }).addTo(newMap);\n\n    setMap(newMap);\n\n    return () => {\n      newMap.remove();\n    };\n  }, []);\n\n  // Update ambulance marker\n  useEffect(() => {\n    if (!map || !ambulanceLocation) return;\n\n    if (ambulanceMarker) {\n      ambulanceMarker.setLatLng([ambulanceLocation.latitude, ambulanceLocation.longitude]);\n    } else {\n      const marker = L.marker([ambulanceLocation.latitude, ambulanceLocation.longitude], {\n        icon: L.divIcon({\n          className: 'bg-transparent border-none',\n          html: `\n            <div class=\"relative flex items-center justify-center w-12 h-12\">\n              <div class=\"absolute inset-0 bg-blue-500 rounded-full animate-ping opacity-30\"></div>\n              <div class=\"relative flex items-center justify-center w-10 h-10 bg-[#1b2230] border-2 border-blue-500 rounded-full shadow-xl z-10 transition-transform hover:scale-110\">\n                 <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#3b82f6\" stroke-width=\"2.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M10 17h4V5H2v12h3M22 17h-2v-5l-3-4h-3M22 17v-4.5M2 17a3 3 0 1 0 6 0 3 3 0 1 0-6 0M14 17a3 3 0 1 0 6 0 3 3 0 1 0-6 0M4.5 10.5h3v-3h3v3h3\"/></svg>\n              </div>\n            </div>\n          `,\n          iconSize: [48, 48],\n          iconAnchor: [24, 24],\n          popupAnchor: [0, -24],\n        }),\n      }).addTo(map);\n\n      marker.bindPopup('Current Location');\n      setAmbulanceMarker(marker);\n      map.setView([ambulanceLocation.latitude, ambulanceLocation.longitude], 13);\n    }\n  }, [map, ambulanceLocation, ambulanceMarker]);\n\n  // Update hospital marker and route\n  useEffect(() => {\n    if (!map || !hospitalLocation) return;\n\n    if (hospitalMarker) {\n      hospitalMarker.setLatLng([hospitalLocation.latitude, hospitalLocation.longitude]);\n    } else {\n      const marker = L.marker([hospitalLocation.latitude, hospitalLocation.longitude], {\n        icon: L.divIcon({\n          className: 'bg-transparent border-none',\n          html: `\n            <div class=\"relative flex items-center justify-center w-12 h-12\">\n              <div class=\"absolute inset-0 bg-red-500 rounded-full animate-ping opacity-20\"></div>\n              <div class=\"relative flex items-center justify-center w-10 h-10 bg-red-600 border-2 border-white rounded-full shadow-2xl z-10 transition-transform hover:scale-110\">\n                 <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"20\" height=\"20\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"#ffffff\" stroke-width=\"3\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M12 2v20M2 12h20\"/></svg>\n              </div>\n            </div>\n          `,\n          iconSize: [48, 48],\n          iconAnchor: [24, 24],\n          popupAnchor: [0, -24],\n        }),\n      }).addTo(map);\n\n      marker.bindPopup('Hospital Destination');\n      setHospitalMarker(marker);\n    }\n\n    // Draw route\n    if (ambulanceLocation && hospitalLocation) {\n      const fetchRoute = async () => {\n        try {\n          // OpenRouteService expects longitude,latitude\n          const start = `${ambulanceLocation.longitude},${ambulanceLocation.latitude}`;\n          const end = `${hospitalLocation.longitude},${hospitalLocation.latitude}`;\n          const url = `https://router.project-osrm.org/route/v1/driving/${ambulanceLocation.longitude},${ambulanceLocation.latitude};${hospitalLocation.longitude},${hospitalLocation.latitude}?geometries=geojson`;\n          \n          const response = await fetch(url);\n          \n          if (!response.ok) throw new Error('Route fetch failed');\n          \n          const data = await response.json();\n          let routeCoordinates: [number, number][] = [];\n          \n          if (data.routes && data.routes.length > 0) {\n            // OSRM returns coordinates directly in geojson format [lng, lat]\n            routeCoordinates = data.routes[0].geometry.coordinates.map((coord: [number, number]) => [coord[1], coord[0]]);\n          } else {\n             routeCoordinates = [\n              [ambulanceLocation.latitude, ambulanceLocation.longitude],\n              [hospitalLocation.latitude, hospitalLocation.longitude],\n            ];\n          }\n\n          // Remove Fake generator fallbacks\n          if (routeCoordinates.length === 0) {\n             routeCoordinates = [\n              [ambulanceLocation.latitude, ambulanceLocation.longitude],\n              [hospitalLocation.latitude, hospitalLocation.longitude],\n            ];\n          }\n\n          setActiveRoutePoints(routeCoordinates);          if (routeRef.current) {\n            map.removeLayer(routeRef.current);\n          }\n\n          const newRoute = L.polyline(routeCoordinates, {\n            color: '#3b82f6', // Changed to blue to indicate actual routing\n            weight: 4,\n            opacity: 0.8,\n            dashArray: undefined, // Solid line for actual roads\n          }).addTo(map);\n\n          routeRef.current = newRoute;\n\n          // Fit bounds to show the whole route\n          map.fitBounds(newRoute.getBounds().pad(0.1));\n        } catch (error) {\n          console.error(\"Error drawing map route:\", error);\n          \n          // Fallback on error\n          if (routeRef.current) map.removeLayer(routeRef.current);\n          routeRef.current = L.polyline(\n            [\n              [ambulanceLocation.latitude, ambulanceLocation.longitude],\n              [hospitalLocation.latitude, hospitalLocation.longitude],\n            ],\n            { color: '#ef4444', weight: 3, dashArray: '5, 5' }\n          ).addTo(map);\n        }\n      };\n\n      fetchRoute();\n    } else {\n        setActiveRoutePoints([]);\n    }\n  }, [map, hospitalLocation, ambulanceLocation, hospitalMarker]);\n\n  // Traffic Signal Simulation\n  useEffect(() => {\n    if (!isTrafficCleared || !map || !ambulanceMarker || activeRoutePoints.length === 0) return;\n\n    // Pick 3 points as traffic signals along the route\n    const signals = [\n      activeRoutePoints[Math.floor(activeRoutePoints.length * 0.25)],\n      activeRoutePoints[Math.floor(activeRoutePoints.length * 0.50)],\n      activeRoutePoints[Math.floor(activeRoutePoints.length * 0.75)],\n    ];\n\n    const getSignalIcon = (isGreen: boolean) => L.divIcon({\n      className: 'bg-transparent border-none',\n      html: `\n        <div class=\"relative flex items-center justify-center w-8 h-8\">\n          <div class=\"w-5 h-5 rounded-full border-2 border-[#1b2230] flex ${isGreen ? 'bg-green-500 shadow-[0_0_20px_#22c55e]' : 'bg-red-500 shadow-[0_0_20px_#ef4444]'} transition-colors duration-300\"></div>\n        </div>\n      `,\n      iconSize: [32, 32],\n      iconAnchor: [16, 16]\n    });\n\n    const signalLeafletMarkers = signals.map(sig => {\n       return L.marker(sig, { icon: getSignalIcon(false) }).addTo(map);\n    });\n\n    let step = 0;\n    const interval = setInterval(() => {\n       step += 1;\n       if (step >= activeRoutePoints.length) {\n          clearInterval(interval);\n          return;\n       }\n       const currentLoc = activeRoutePoints[step];\n       \n       ambulanceMarker.setLatLng(currentLoc);\n       map.panTo(currentLoc, { animate: true, duration: 0.1 });\n\n       signalLeafletMarkers.forEach((sigMarker, idx) => {\n          const sig = signals[idx];\n          // Simple euclidian distance map logic\n          const dist = Math.sqrt(Math.pow(currentLoc[0] - sig[0], 2) + Math.pow(currentLoc[1] - sig[1], 2));\n          const isGreen = dist < 0.005; // Roughly 500m threshold on latlng metrics\n          sigMarker.setIcon(getSignalIcon(isGreen));\n       });\n    }, 1000); // Drastically slower interval\n\n    return () => {\n      clearInterval(interval);\n      signalLeafletMarkers.forEach(m => map.removeLayer(m));\n    };\n  }, [isTrafficCleared, map, ambulanceMarker, activeRoutePoints]);\n\n  return (\n    <div className={className}>\n      <div id=\"ambulance-map\" className=\"w-full h-full\" />\n    </div>\n  );\n}\n"],"names":[],"mappings":"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"}}]
}